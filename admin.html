<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>多益刷題後台</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 24px;
      background-color: #f2f5f8;
      color: #2b2b2b;
      font-size: 14px;
    }

    h1 {
      text-align: center;
      color: #1e3a8a;
      margin-bottom: 30px;
    }

    .section {
      background-color: #ffffff;
      border-radius: 8px;
      padding: 20px 24px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
      margin-bottom: 32px;
    }

    .section h2 {
      font-size: 17px;
      color: #1e293b;
      border-left: 4px solid #3b82f6;
      padding-left: 10px;
      margin-bottom: 16px;
    }

    .section label {
      font-weight: 600;
      margin-top: 10px;
      margin-bottom: 4px;
      display: block;
    }

    input, textarea, select {
      width: 100%;
      font-size: 14px;
      padding: 6px 10px;
      margin-bottom: 12px;
      border: 1px solid #cbd5e1;
      border-radius: 4px;
      box-sizing: border-box;
      background-color: #f8fafc;
    }

    textarea {
      resize: vertical;
    }

    button {
      padding: 8px 14px;
      margin-top: 6px;
      font-size: 14px;
      background-color: #3b82f6;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #2563eb;
    }
    button.danger {
      background-color: #ef4444;
    }
    button.danger:hover {
      background-color: #dc2626;
    }
    button.secondary {
      background-color: #64748b;
    }
    button.secondary:hover {
      background-color: #475569;
    }

    .question-block {
      border: 1px solid #cbd5e1;
      background-color: #f9fafb;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
    }

    #questionList {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    .question-block strong {
      color: #1e40af;
    }

    .question-form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px 12px;
      align-items: center;
    }
    .question-form textarea {
      grid-column: span 2;
    }
    .question-form button {
      grid-column: span 2;
      justify-self: end;
      margin-top: 6px;
    }
    .field-group {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 6px;
      grid-column: span 1;
    }
    .field-group label {
      white-space: nowrap;
      min-width: 80px;
      font-weight: bold;
      text-align: right;
    }
    .field-group input,
    .field-group select {
      flex: 1;
    }
    #pagination {
      margin-top: 20px;
      text-align: center;
    }
    #pagination button {
      margin: 2px;
      background-color: #e2e8f0;
      color: #1e293b;
    }
    #pagination button:disabled {
      background-color: #94a3b8;
      color: white;
    }
    #promoListContainer textarea {
      width: 100%;
      margin-bottom: 8px;
      background-color: #fffefc;
    }
    #promoPreview {
      padding: 12px;
      background-color: #fefce8;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      margin-top: 8px;
    }

    /* 宣傳區塊消除上下空白 */
    .promo-block {
      margin: 0;
      padding: 0;
    }

    #promoListContainer textarea {
      margin: 0;
    }

    #promoPreview {
      margin: 0;
      padding: 0;
    }

</style>
</style>
  <style>
    /* Tooltip Form 樣式 */
    .tooltip-form {
      margin-top: 8px;
      background: #f8fafc;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      padding: 12px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }
    .tooltip-form label {
      display: block;
      font-weight: bold;
      margin-bottom: 4px;
    }
    .tooltip-form input {
      width: 100%;
      margin-bottom: 10px;
      padding: 6px 8px;
      border: 1px solid #cbd5e1;
      border-radius: 4px;
      background: #ffffff;
    }
  </style>
</head>
<body>
  <div id="loginBox">
    <h2>後台登入</h2>
    <input id="email" type="text" placeholder="Email" />
    <input id="password" type="password" placeholder="Password" />
    <button onclick="window.login()">登入</button>
  </div>
  <div id="mainContent" style="display:none">
  <h1>多益刷題後台管理</h1>

  <div class="section">
    <h2>前台設定（密碼）</h2>
    <label>第一組密碼（好友）：<input type="text" id="pwFriend" placeholder="friend456"></label>
    <label>第二組密碼（學員）：<input type="text" id="pwStudent" placeholder="student123"></label>
    <button onclick="saveSettings()">儲存密碼設定</button>
  </div>

  <div class="section">
    <h2>新增題目</h2>
    <label for="qText">題目</label>
    <input id="qText" placeholder="請輸入題目內容" />
    <label for="qOptions">選項（請用逗號分隔）</label>
    <input id="qOptions" placeholder="例如：success, successful, successfully, succeed" />
    <label for="qAnswer">正確答案（如 A/B/C/D）</label>
    <input id="qAnswer" placeholder="請輸入正確答案代號" />
    <label for="qExplanation">解析</label>
    <button type="button" class="secondary" onclick="insertTooltipForm(document.getElementById('qExplanation'))">插入 Tooltip</button>
    <textarea id="qExplanation" placeholder="解釋正確答案的理由"></textarea>
    <label for="qHint">提示</label>
    <button type="button" class="secondary" onclick="insertTooltipForm(document.getElementById('qHint'))">插入 Tooltip</button>
    <textarea id="qHint" placeholder="提供給學生的解題提示"></textarea>
    <label for="qDeleteWords">刪除文字（用逗號分隔）</label>
    <input id="qDeleteWords" placeholder="例如：highly, in the new position" />
    <label for="qFreq">頻率</label>
    <select id="qFreq">
      <option value="高頻">高頻</option>
      <option value="普通">普通</option>
      <option value="低頻">低頻</option>
    </select>
    <label for="qLevel">難度</label>
    <select id="qLevel">
      <option value="進階">進階</option>
      <option value="普通">普通</option>
      <option value="簡單">簡單</option>
    </select>
    <label for="qType">類型</label>
    <select id="qType">
      <option value="真題">真題</option>
      <option value="題庫">題庫</option>
    </select>
    <label for="qAuth">權限</label>
    <select id="qAuth">
      <option value="學員">學員</option>
      <option value="好友">好友</option>
      <option value="訪客">訪客</option>
    </select>
    <label for="qCategory">主題分類</label>
    <select id="qCategory"></select>
    <script>
      const qCatSelect = document.getElementById('qCategory');
      qCatSelect.innerHTML = '<option value="">--請選擇文法主題--</option>' +
        categoryList.map(cat => `<option value="${cat}">${cat}</option>`).join('');
    </script>
    <button id="addBtn">新增題目</button>
  </div>

  <div class="section">
    <h2>題庫管理</h2>
    <button onclick="downloadQuestions()">📤 匯出題庫</button>
    <input type="file" id="fileInput" accept=".json" />
    <button onclick="uploadQuestions()">📥 匯入題庫</button>
    <select id="filterCategory" onchange="renderQuestions()"></select>
    <script>
      const filterSelect = document.getElementById('filterCategory');
      filterSelect.innerHTML = '<option value="">🔍 篩選主題（全部）</option>' +
        categoryList.map(cat => `<option value="${cat}">${cat}</option>`).join('');
    </script>
    <button id="toggleViewModeBtn" style="margin-left:10px;">📦 切換為表格模式</button>
  </div>

  <div class="section">
    <h2>批次套用標籤（依題號）</h2>
    <div class="field-group">
      <label>起始題號：</label>
      <input id="batchStart" type="number" min="1" />
    </div>
    <div class="field-group">
      <label>結束題號：</label>
      <input id="batchEnd" type="number" min="1" />
    </div>
    <div class="field-group">
      <label>頻率：</label>
      <select id="batchFreq">
        <option value="">-- 不變更 --</option>
        <option value="高頻">高頻</option>
        <option value="普通">普通</option>
        <option value="低頻">低頻</option>
      </select>
    </div>
    <div class="field-group">
      <label>難度：</label>
      <select id="batchLevel">
        <option value="">-- 不變更 --</option>
        <option value="進階">進階</option>
        <option value="普通">普通</option>
        <option value="簡單">簡單</option>
      </select>
    </div>
    <div class="field-group">
      <label>類型：</label>
      <select id="batchType">
        <option value="">-- 不變更 --</option>
        <option value="真題">真題</option>
        <option value="題庫">題庫</option>
      </select>
    </div>
    <div class="field-group">
      <label>權限：</label>
      <select id="batchAuth">
        <option value="">-- 不變更 --</option>
        <option value="學員">學員</option>
        <option value="好友">好友</option>
        <option value="訪客">訪客</option>
      </select>
    </div>
    <button onclick="applyBatchLabels()">📦 套用標籤至指定題目</button>
  </div>
  <script>

    // 批次套用標籤功能
    function applyBatchLabels() {
      const start = parseInt(document.getElementById('batchStart').value) - 1;
      const end = parseInt(document.getElementById('batchEnd').value) - 1;

      if (isNaN(start) || isNaN(end) || start < 0 || end < start || end >= questions.length) {
        alert("請輸入有效的題號範圍");
        return;
      }

      const freq = document.getElementById('batchFreq').value;
      const level = document.getElementById('batchLevel').value;
      const type = document.getElementById('batchType').value;
      const auth = document.getElementById('batchAuth').value;

      for (let i = start; i <= end; i++) {
        if (freq) questions[i].freq = freq;
        if (level) questions[i].level = level;
        if (type) questions[i].type = type;
        if (auth) questions[i].auth = auth;
      }

      saveQuestions();
      renderQuestions();
      alert("✅ 標籤套用成功！");
    }
</script>

  <div class="section alwaysVisible">
    <h2>現有題目</h2>
    <div style="text-align:right; margin-bottom:8px;">
      <button onclick="clearAllQuestions()" style="background-color: darkred; color: white; margin-left: 10px;">🧹 清空全部題目</button>
    </div>
    <div id="questionList"></div>
    <div id="pagination" style="margin-top: 20px; text-align: center;"></div>
  </div>

  <!-- 主題分類管理區塊從宣傳管理分離，移至現有題目區塊之後 -->

  <div class="section">
    <h2>宣傳內容管理（多組 / 支援 HTML）</h2>
    <div id="promoListContainer"></div>
    <button onclick="addPromoItem()">➕ 新增一段宣傳</button>
    <button onclick="savePromoList()" style="margin-left:10px;">💾 儲存所有宣傳</button>
    <button onclick="clearPromoList()" style="margin-left:10px; background-color: darkred;">🧹 清空全部宣傳</button>
    <div id="promoSaveStatus" style="margin-top:10px; color:green; font-weight:bold;"></div>

    <h3>🔍 預覽區</h3>
    <div id="promoPreview"></div>
  </div>

  <!-- 主題分類管理區塊移至此處 -->
  <div class="section">
    <h2>主題分類管理</h2>
    <ul id="categoryList" style="margin-bottom: 12px;"></ul>
    <input type="text" id="newCategory" placeholder="新增分類名稱" style="width:70%;display:inline-block;margin-right:8px;" />
    <button onclick="addCategory()">➕ 新增分類</button>
  </div>

  </div>

  <script>

let categoryList = [
  "句子基本架構1", "主詞動詞一致性", "代名詞與格位用法", "名詞與形容詞搭配",
  "比較級與最高級", "介系詞的用法", "動詞種類與搭配", "動詞時態",
  "動名詞與不定詞", "子句與分詞構句", "副詞與連接詞比較", "動詞片語",
  "假設語氣與條件句", "倒裝與省略", "形容詞子句進階用法", "特殊文法結構"
];
// 主題分類管理功能
function renderCategoryList() {
  const ul = document.getElementById('categoryList');
  ul.innerHTML = '';
  categoryList.forEach((cat, idx) => {
    const li = document.createElement('li');
    li.style.display = 'flex';
    li.style.justifyContent = 'space-between';
    li.style.marginBottom = '4px';
    li.innerHTML = `
      <span style="margin-right: 8px;">${idx + 1}.</span>
      <input type="text" value="${cat}" onchange="updateCategory(${idx}, this.value)" style="flex:1; margin-right: 8px;" />
      <button class="danger" onclick="deleteCategory(${idx})">🗑️</button>
    `;
    ul.appendChild(li);
  });
  refreshCategorySelects();
}
// 分類名稱更新
function updateCategory(index, newValue) {
  newValue = newValue.trim();
  if (!newValue) return alert("分類名稱不得為空");
  if (categoryList.includes(newValue)) return alert("已有重複分類名稱");
  categoryList[index] = newValue;
  renderCategoryList();
}

function addCategory() {
  const input = document.getElementById('newCategory');
  const value = input.value.trim();
  if (!value) return alert("請輸入分類名稱");
  if (categoryList.includes(value)) return alert("分類名稱已存在");
  categoryList.push(value);
  input.value = '';
  renderCategoryList();
}

function deleteCategory(index) {
  if (!confirm("確定要刪除這個分類嗎？")) return;
  categoryList.splice(index, 1);
  renderCategoryList();
}

function refreshCategorySelects() {
  // 更新所有使用 categoryList 的 select 元件
  const categoryHTML = '<option value="">--請選擇文法主題--</option>' +
    categoryList.map(cat => `<option value="${cat}">${cat}</option>`).join('');
  document.getElementById('qCategory').innerHTML = categoryHTML;
  document.getElementById('filterCategory').innerHTML = '<option value="">🔍 篩選主題（全部）</option>' +
    categoryList.map(cat => `<option value="${cat}">${cat}</option>`).join('');
  renderQuestions(); // 重新渲染題目區
}

window.addEventListener('DOMContentLoaded', renderCategoryList);

    let questions = [];
    let currentPage = 1;
    const questionsPerPage = 20;

    function saveQuestions() {
      localStorage.setItem('toeicQuestions', JSON.stringify(questions));
    }

    function loadQuestions() {
      const saved = localStorage.getItem('toeicQuestions');
      if (saved) {
        try { questions = JSON.parse(saved); } catch (e) { questions = []; }
      }
    }

    function renderQuestions() {
      const list = document.getElementById('questionList');
      const filter = document.getElementById('filterCategory')?.value;
      const pagination = document.getElementById('pagination');
      list.innerHTML = '';
      pagination.innerHTML = '';

      // 若為表格模式，改用 renderTableMode
      if (window.isTableMode) {
        renderTableMode();
        return;
      }
      // 篩選後的題目
      const filtered = questions.filter(q => !filter || q.category === filter);
      const totalPages = Math.ceil(filtered.length / questionsPerPage);
      // 若目前頁超過最大頁，重設
      if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;
      if (currentPage < 1) currentPage = 1;
      const startIdx = (currentPage - 1) * questionsPerPage;
      const endIdx = startIdx + questionsPerPage;
      const pageItems = filtered.slice(startIdx, endIdx);

      pageItems.forEach((q, idx) => {
        const globalIndex = startIdx + idx;
        const block = document.createElement('div');
        block.className = 'question-block';

        // 題號、收合、刪除按鈕合併橫排
        const header = document.createElement('div');
        header.style.display = 'flex';
        header.style.justifyContent = 'space-between';
        header.style.alignItems = 'center';

        const title = document.createElement('strong');
        title.textContent = `Q${globalIndex + 1}`;

        const rightBtns = document.createElement('div');
        rightBtns.style.display = 'flex';
        rightBtns.style.gap = '6px';

        const toggleBtn = document.createElement('button');
        // 展開/收合按鈕顯示
        let isExpanded = false;
        if (typeof window.lastAddedIndex === 'number' && globalIndex === window.lastAddedIndex - 1) {
          isExpanded = true;
        }
        toggleBtn.textContent = isExpanded ? '🔽 收合' : '🔼 展開';
        toggleBtn.onclick = () => {
          const form = block.querySelector('.question-form');
          const isHidden = form.style.display === 'none';
          form.style.display = isHidden ? '' : 'none';
          toggleBtn.textContent = isHidden ? '🔽 收合' : '🔼 展開';
        };

        const delBtn = document.createElement('button');
        delBtn.textContent = '🗑️';
        delBtn.className = 'danger';
        delBtn.title = '刪除本題';
        delBtn.onclick = () => deleteQuestion(globalIndex);

        rightBtns.appendChild(toggleBtn);
        rightBtns.appendChild(delBtn);

        header.appendChild(title);
        header.appendChild(rightBtns);
        block.appendChild(header);

        // 題目內容區（可收合）
        const formDiv = document.createElement('div');
        formDiv.className = 'question-form';

        // 是否預設展開
        if (typeof window.lastAddedIndex === 'number' && globalIndex === window.lastAddedIndex - 1) {
          formDiv.style.display = '';
        } else {
          formDiv.style.display = 'none';
        }

        // 解析 textarea + 插入 Tooltip 按鈕
        const explanationId = `explanation-${globalIndex}`;
        const hintId = `hint-${globalIndex}`;

        formDiv.innerHTML = `
          <div class="field-group" style="grid-column: span 2;">
            <label>題目：</label>
            <input value="${q.text}" onchange="questions[${globalIndex}].text = this.value; saveQuestions()" />
          </div>
          <div class="field-group">
            <label>正確答案：</label>
            <input value="${q.answer}" onchange="questions[${globalIndex}].answer = this.value; saveQuestions()" />
          </div>
          <div class="field-group">
            <label>選項：</label>
            <input value="${q.options.join(', ')}" onchange="questions[${globalIndex}].options = this.value.split(',').map(x => x.trim()); saveQuestions()" />
          </div>
          <div class="field-group" style="grid-column: span 2;">
            <label>解析：</label>
            <textarea id="${explanationId}" rows="3" style="flex:1" onchange="questions[${globalIndex}].explanation = this.value; saveQuestions()">${q.explanation}</textarea>
            <button type="button" class="secondary" onclick="insertTooltipForm(this.previousElementSibling)">插入 Tooltip</button>
          </div>
          <div class="field-group" style="grid-column: span 2;">
            <label>提示：</label>
            <textarea id="${hintId}" rows="2" style="flex:1" onchange="questions[${globalIndex}].hint = this.value; saveQuestions()">${q.hint}</textarea>
            <button type="button" class="secondary" onclick="insertTooltipForm(this.previousElementSibling)">插入 Tooltip</button>
          </div>
          <div class="field-group" style="grid-column: span 2;">
            <label>刪除文字：</label>
            <input style="flex:1" value="${q.deleteWords?.join(', ') ?? ''}" onchange="questions[${globalIndex}].deleteWords = this.value.split(',').map(x => x.trim()); saveQuestions()">
          </div>
          <div class="field-group">
            <label>頻率：</label>
            <select onchange="questions[${globalIndex}].freq = this.value; saveQuestions()">
              <option ${q.freq==='高頻'?'selected':''}>高頻</option>
              <option ${q.freq==='普通'?'selected':''}>普通</option>
              <option ${q.freq==='低頻'?'selected':''}>低頻</option>
            </select>
          </div>
          <div class="field-group">
            <label>難度：</label>
            <select onchange="questions[${globalIndex}].level = this.value; saveQuestions()">
              <option ${q.level==='進階'?'selected':''}>進階</option>
              <option ${q.level==='普通'?'selected':''}>普通</option>
              <option ${q.level==='簡單'?'selected':''}>簡單</option>
            </select>
          </div>
          <div class="field-group">
            <label>類型：</label>
            <select onchange="questions[${globalIndex}].type = this.value; saveQuestions()">
              <option ${q.type==='真題'?'selected':''}>真題</option>
              <option ${q.type==='題庫'?'selected':''}>題庫</option>
            </select>
          </div>
          <div class="field-group">
            <label>權限：</label>
            <select onchange="questions[${globalIndex}].auth = this.value; saveQuestions()">
              <option ${q.auth==='學員'?'selected':''}>學員</option>
              <option ${q.auth==='好友'?'selected':''}>好友</option>
              <option ${q.auth==='訪客'?'selected':''}>訪客</option>
            </select>
          </div>
          <div class="field-group" style="grid-column: span 2;">
            <label>主題分類：</label>
<select style="flex:1" onchange="questions[${globalIndex}].category = this.value; saveQuestions()">
  ${categoryList.map(cat => `<option ${q.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}
</select>
          </div>
        `;

        block.appendChild(formDiv);
        list.appendChild(block);
      });

      // 建立分頁按鈕
      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.style.margin = '0 4px';
        btn.disabled = i === currentPage;
        btn.onclick = () => {
          currentPage = i;
          renderQuestions();
        };
        pagination.appendChild(btn);
      }
    }

    // 表格編輯模式
    function renderTableMode() {
      const container = document.getElementById('questionList');
      const pagination = document.getElementById('pagination');
      container.innerHTML = '';
      pagination.innerHTML = '';

      const table = document.createElement('table');
      table.style.width = '100%';
      table.style.borderCollapse = 'collapse';
      table.innerHTML = `
        <thead>
          <tr style="background:#f1f5f9;">
            <th style="min-width:40px;">#</th>
            <th style="min-width:60px;">答案</th>
            <th style="min-width:180px;">解析</th>
            <th style="min-width:180px;">提示</th>
            <th style="min-width:100px;">分類</th>
            <th style="min-width:100px;">頻率</th>
            <th style="min-width:100px;">難度</th>
            <th style="min-width:100px;">類型</th>
            <th style="min-width:100px;">權限</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;

      const tbody = table.querySelector('tbody');

      questions.forEach((q, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="padding:4px;">Q${idx + 1}</td>
          <td>
            <select style="min-width:60px;">
              ${['A','B','C','D'].map(opt => `<option ${q.answer === opt ? 'selected' : ''}>${opt}</option>`).join('')}
            </select>
          </td>
          <td>
            <textarea rows="2" style="min-width:180px;">${q.explanation || ''}</textarea>
          </td>
          <td>
            <textarea rows="2" style="min-width:180px;">${q.hint || ''}</textarea>
          </td>
          <td>
            <select style="min-width:100px;">
              ${categoryList.map(cat => `<option ${q.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}
            </select>
          </td>
          <td>
            <select style="min-width:100px;">
              <option ${q.freq==='高頻'?'selected':''}>高頻</option>
              <option ${q.freq==='普通'?'selected':''}>普通</option>
              <option ${q.freq==='低頻'?'selected':''}>低頻</option>
            </select>
          </td>
          <td>
            <select style="min-width:100px;">
              <option ${q.level==='進階'?'selected':''}>進階</option>
              <option ${q.level==='普通'?'selected':''}>普通</option>
              <option ${q.level==='簡單'?'selected':''}>簡單</option>
            </select>
          </td>
          <td>
            <select style="min-width:100px;">
              <option ${q.type==='真題'?'selected':''}>真題</option>
              <option ${q.type==='題庫'?'selected':''}>題庫</option>
            </select>
          </td>
          <td>
            <select style="min-width:100px;">
              <option ${q.auth==='學員'?'selected':''}>學員</option>
              <option ${q.auth==='好友'?'selected':''}>好友</option>
              <option ${q.auth==='訪客'?'selected':''}>訪客</option>
            </select>
          </td>
        `;

        // 順序: 答案、解析、提示、分類、頻率、難度、類型、權限
        const selectsAndTextareas = tr.querySelectorAll('select, textarea');
        const [
          answerSel, // 0
          explInput, // 1
          hintInput, // 2
          catSel,    // 3
          freqSel,   // 4
          levelSel,  // 5
          typeSel,   // 6
          authSel    // 7
        ] = selectsAndTextareas;
        answerSel.onchange = () => { q.answer = answerSel.value; saveQuestions(); };
        explInput.onchange = () => { q.explanation = explInput.value; saveQuestions(); };
        hintInput.onchange = () => { q.hint = hintInput.value; saveQuestions(); };
        catSel.onchange = () => { q.category = catSel.value; saveQuestions(); };
        freqSel.onchange = () => { q.freq = freqSel.value; saveQuestions(); };
        levelSel.onchange = () => { q.level = levelSel.value; saveQuestions(); };
        typeSel.onchange = () => { q.type = typeSel.value; saveQuestions(); };
        authSel.onchange = () => { q.auth = authSel.value; saveQuestions(); };

        tbody.appendChild(tr);
      });

      container.appendChild(table);
    }
    // 模式切換
    window.isTableMode = false;
    document.getElementById('toggleViewModeBtn').onclick = () => {
      window.isTableMode = !window.isTableMode;
      document.getElementById('toggleViewModeBtn').textContent = window.isTableMode ? '🗂 切換為卡片模式' : '📦 切換為表格模式';
      if (window.isTableMode) {
        renderTableMode();
      } else {
        renderQuestions();
      }
    };

    function addQuestion() {
      const qText = document.getElementById('qText').value.trim();
      const qOptions = document.getElementById('qOptions').value.split(',').map(x => x.trim());
      const qAnswer = document.getElementById('qAnswer').value.trim();
      if (!qText || qOptions.length < 2 || !qAnswer) {
        alert("請填寫題目、至少兩個選項與正確答案"); return;
      }
      const q = {
        text: qText,
        options: qOptions,
        answer: qAnswer,
        explanation: document.getElementById('qExplanation').value.trim(),
        hint: document.getElementById('qHint').value.trim(),
        deleteWords: document.getElementById('qDeleteWords').value.split(',').map(x => x.trim()),
        freq: document.getElementById('qFreq').value,
        level: document.getElementById('qLevel').value,
        type: document.getElementById('qType').value,
        auth: document.getElementById('qAuth').value,
        category: document.getElementById('qCategory').value
      };
      questions.push(q);
      window.lastAddedIndex = questions.length;
      saveQuestions(); renderQuestions();
      document.querySelectorAll('#qText, #qOptions, #qAnswer, #qExplanation, #qHint, #qDeleteWords').forEach(e => e.value = '');
      ['qFreq','qLevel','qType','qAuth','qCategory'].forEach(id => document.getElementById(id).selectedIndex = 0);
    }

    function deleteQuestion(index) {
      if (confirm("確定要刪除這題嗎？")) {
        questions.splice(index, 1);
        saveQuestions(); renderQuestions();
      }
    }

    function saveSettings() {
      const settings = {
        passwordStudent: document.getElementById('pwStudent').value.trim(),
        passwordFriend: document.getElementById('pwFriend').value.trim()
      };
      localStorage.setItem('toeicSettings', JSON.stringify(settings));
      alert("密碼設定已儲存！");
    }

    function loadSettings() {
      const saved = localStorage.getItem('toeicSettings');
      if (saved) {
        try {
          const settings = JSON.parse(saved);
          document.getElementById('pwStudent').value = settings.passwordStudent || '';
          document.getElementById('pwFriend').value = settings.passwordFriend || '';
        } catch {}
      }
    }

    function downloadQuestions() {
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(questions, null, 2));
      const dlAnchorElem = document.createElement('a');
      dlAnchorElem.setAttribute("href", dataStr);
      dlAnchorElem.setAttribute("download", "toeic_questions.json");
      dlAnchorElem.click();
    }

    function uploadQuestions() {
      const fileInput = document.getElementById('fileInput');
      if (!fileInput.files.length) { alert("請選擇 JSON 檔案"); return; }
      const file = fileInput.files[0];
      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const imported = JSON.parse(e.target.result);
          if (Array.isArray(imported)) {
            questions = questions.concat(imported);
            saveQuestions(); renderQuestions();
            alert("題庫匯入成功！");
          } else {
            alert("格式錯誤，請確認為題庫 JSON 檔");
          }
        } catch (err) {
          alert("讀取錯誤：" + err.message);
        }
      };
      reader.readAsText(file);
    }

    document.getElementById('addBtn').addEventListener('click', addQuestion);
    // Firebase 載入後會自動 renderQuestions()

    // 全部展開/收合功能已移除，避免與整體收合設計重複

    // 清空全部題目
    function clearAllQuestions() {
      if (confirm("⚠️ 確定要刪除全部題目嗎？此動作無法還原！")) {
        questions = [];
        localStorage.removeItem('toeicQuestions');
        saveQuestions();
        renderQuestions();
        alert("✅ 題庫已清空！");
      }
    }


    function renderPromoEditor() {
      let list = [];
      try {
        list = JSON.parse(localStorage.getItem('toeicPromoList'));
        if (!Array.isArray(list)) throw 'invalid format';
      } catch {
        list = [];
      }

      const container = document.getElementById('promoListContainer');
      container.innerHTML = '';

      list.forEach((html, idx) => {
        const block = document.createElement('div');
        block.className = 'promo-block';

        const label = document.createElement('div');
        label.textContent = `第 ${idx + 1} 段宣傳內容：`;
        label.style.fontWeight = 'bold';

        const textarea = document.createElement('textarea');
        textarea.value = html;
        textarea.rows = 5;
        textarea.dataset.index = idx;
        textarea.oninput = () => previewPromo(textarea.value);

        const delBtn = document.createElement('button');
        delBtn.textContent = '🗑️ 刪除';
        delBtn.onclick = () => {
          list.splice(idx, 1);
          localStorage.setItem('toeicPromoList', JSON.stringify(list));
          renderPromoEditor();
        };

        block.appendChild(label);
        block.appendChild(textarea);
        block.appendChild(delBtn);
        container.appendChild(block);
      });
    }

    function addPromoItem() {
      const list = getCurrentList();
      list.push('<p>請在此輸入 HTML 宣傳內容</p>');
      localStorage.setItem('toeicPromoList', JSON.stringify(list));
      renderPromoEditor();
    }

    function savePromoList() {
      const updated = Array.from(document.querySelectorAll('#promoListContainer textarea')).map(t => t.value);
      try {
        localStorage.setItem('toeicPromoList', JSON.stringify(updated));
        document.getElementById('promoSaveStatus').textContent = '✅ 宣傳內容已儲存';
      } catch (e) {
        document.getElementById('promoSaveStatus').textContent = '❌ 儲存失敗，請檢查內容格式';
      }
      setTimeout(() => document.getElementById('promoSaveStatus').textContent = '', 3000);
      renderPromoEditor();
    }

    function clearPromoList() {
  localStorage.removeItem('toeicPromoList');
  document.getElementById('promoSaveStatus').textContent = '🧹 已清空全部宣傳';
  setTimeout(() => document.getElementById('promoSaveStatus').textContent = '', 3000);
  renderPromoEditor();
}

    function previewPromo(html) {
      document.getElementById('promoPreview').innerHTML = html;
    }

    function getCurrentList() {
      try {
        const data = JSON.parse(localStorage.getItem('toeicPromoList'));
        return Array.isArray(data) ? data : [];
      } catch {
        return [];
      }
    }

    // 僅首次初始化時提供預設資料
    try {
      const current = JSON.parse(localStorage.getItem('toeicPromoList'));
      if (!Array.isArray(current)) throw 'invalid';
    } catch {
      localStorage.setItem('toeicPromoList', JSON.stringify([
        "<p>🎓 <strong>加入文法精修班</strong>，系統化提升你的英文寫作能力！<br><a href='https://yourcourse.com/grammar' target='_blank'>👉 點我了解詳情</a></p>",
        "<p>📚 <strong>免費直播試聽課</strong> 每週五晚上 8 點準時開講！<br><a href='https://yourcourse.com/live' target='_blank'>立即報名</a></p>",
        "<p>🔥 <strong>限時 8 折優惠</strong> 只到本週日！別錯過這次機會～<br><a href='https://yourcourse.com/promo' target='_blank'>搶先看優惠內容</a></p>"
      ]));
    }

    renderPromoEditor();

    // 一鍵同步所有資料到 Firebase（加上 Firebase Token）
    async function saveAllToFirebase() {
      const promoList = getCurrentList();
      const settings = {
        passwordStudent: document.getElementById('pwStudent').value.trim(),
        passwordFriend: document.getElementById('pwFriend').value.trim()
      };
      const dataToSave = { settings, questions, promoList };
      try {
        const token = window.getFirebaseToken?.();
        if (!token) {
          alert("未登入或 Token 失效"); return;
        }
        const response = await fetch("https://toeic-990-johnny-default-rtdb.asia-southeast1.firebasedatabase.app/toeicData.json?auth=" + token, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(dataToSave)
        });
        if (response.ok) {
          alert("✅ 所有資料已成功儲存到 Firebase！");
        } else {
          alert("❌ 儲存失敗，請檢查 Firebase 權限設定");
        }
      } catch (err) {
        alert("❌ 無法取得授權 Token，請重新登入或檢查登入狀態");
        console.error(err);
      }
    }

    // 插入 Tooltip 表單
    function insertTooltipForm(textarea) {
      if (textarea.nextElementSibling?.classList?.contains('tooltip-form')) return;

      const form = document.createElement('div');
      form.className = 'tooltip-form';
      form.innerHTML = `
        <label>選擇提示模板
          <select class="tooltip-template">
            <option value="">-- 自行輸入或選擇模板 --</option>
            <option value="現在式|現在式|https://yourlink.com/present">現在式</option>
            <option value="過去式|過去式|https://yourlink.com/past">過去式</option>
            <option value="句型1|句型1|https://yourlink.com/pattern1">句型 1</option>
            <option value="受詞子句|that 子句|">that 子句（無連結）</option>
          </select>
        </label>
        <label>提示內容 <input type="text" class="tooltip-tip"></label>
        <label>顯示文字 <input type="text" class="tooltip-show"></label>
        <label>超連結網址（可留空）<input type="text" class="tooltip-link"></label>
        <div style="text-align:right; margin-top:6px;">
          <button type="button" class="secondary" onclick="confirmTooltipInsert(this)">插入</button>
          <button type="button" onclick="this.closest('.tooltip-form').remove()">取消</button>
        </div>
      `;
      // 模板選單邏輯
      const templateSelect = form.querySelector('.tooltip-template');
      templateSelect.addEventListener('change', e => {
        const val = e.target.value;
        if (!val) return;
        const [tip, show, link] = val.split('|');
        form.querySelector('.tooltip-tip').value = tip || '';
        form.querySelector('.tooltip-show').value = show || '';
        form.querySelector('.tooltip-link').value = link || '';
      });
      textarea.insertAdjacentElement('afterend', form);
    }

    function confirmTooltipInsert(btn) {
      const form = btn.closest('.tooltip-form');
      const textarea = form.previousElementSibling;
      const tip = form.querySelector('.tooltip-tip').value.trim().replace(/"/g, '&quot;');
      const show = form.querySelector('.tooltip-show').value.trim();
      const link = form.querySelector('.tooltip-link').value.trim();
      const html = link
        ? `<a href="${link}" target="_blank"><span class="tipbox" data-tip="${tip}">${show}</span></a>`
        : `<span class="tipbox" data-tip="${tip}">${show}</span>`;
      textarea.value += (textarea.value ? '\n' : '') + html;
      textarea.focus();
      form.remove();
    }
  </script>


<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCp9Dht56nKx5oq4WELaInsTrgG-KeRJcA",
    authDomain: "toeic-990-johnny.firebaseapp.com",
    databaseURL: "https://toeic-990-johnny-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "toeic-990-johnny",
    storageBucket: "toeic-990-johnny.firebasestorage.app",
    messagingSenderId: "433719887286",
    appId: "1:433719887286:web:43418d0c883462f1746d17"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth();

  async function login() {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    try {
      const userCredential = await signInWithEmailAndPassword(auth, email, password);
      const user = userCredential.user;
      if (user.email !== "johnnyice0109@gmail.com") {
        alert("未授權帳號"); auth.signOut(); return;
      }

      document.getElementById('loginBox').style.display = 'none';
      document.getElementById('mainContent').style.display = '';

      const token = await user.getIdToken();
      const dbUrl = "https://toeic-990-johnny-default-rtdb.asia-southeast1.firebasedatabase.app/toeicData.json?auth=" + token;
      const res = await fetch(dbUrl);
      const data = await res.json();
      if (!data) return;
      questions = data.questions || [];
      const promoRaw = data.promoList || [];
      localStorage.setItem('toeicPromoList', JSON.stringify(promoRaw));
      renderPromoEditor();
      const settings = data.settings || {};
      document.getElementById('pwStudent').value = settings.passwordStudent || '';
      document.getElementById('pwFriend').value = settings.passwordFriend || '';
      renderQuestions();

      window.getFirebaseToken = () => token;
    } catch (e) {
      alert("登入失敗：" + e.message);
    }
  }

  window.login = login;
</script>

</body>
<!-- 浮動儲存全部變更按鈕 -->
<div id="floatingSave" style="position:fixed; bottom:20px; right:20px; z-index:9999;">
  <button onclick="saveAllToFirebase()">💾 儲存所有變更</button>
</div>
<script>
  document.querySelectorAll('.section').forEach((section, idx) => {
    const id = `section-${idx + 1}`;
    section.setAttribute('data-section-id', id);

    const toggleBtn = document.createElement('button');
    section.classList.add('collapsed');
    const isCollapsed = section.classList.contains('collapsed');
    toggleBtn.textContent = isCollapsed ? '🔽 展開' : '🔼 收合';
    toggleBtn.style.marginBottom = '10px';
    toggleBtn.style.float = 'right';
    toggleBtn.onclick = () => {
      const isNowCollapsed = section.classList.toggle('collapsed');
      toggleBtn.textContent = isNowCollapsed ? '🔽 展開' : '🔼 收合';
    };

    section.insertBefore(toggleBtn, section.firstElementChild);
  });

  const style = document.createElement('style');
  style.textContent = `.section.collapsed > *:not(button):not(h2) { display: none !important; }`;
  document.head.appendChild(style);
</script>
</html>