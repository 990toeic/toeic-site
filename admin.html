<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å¤šç›Šåˆ·é¡Œå¾Œå°</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 24px;
      background-color: #f2f5f8;
      color: #2b2b2b;
      font-size: 14px;
    }

    h1 {
      text-align: center;
      color: #1e3a8a;
      margin-bottom: 30px;
    }

    .section {
      background-color: #ffffff;
      border-radius: 8px;
      padding: 20px 24px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
      margin-bottom: 32px;
    }

    .section h2 {
      font-size: 17px;
      color: #1e293b;
      border-left: 4px solid #3b82f6;
      padding-left: 10px;
      margin-bottom: 16px;
    }

    .section label {
      font-weight: 600;
      margin-top: 10px;
      margin-bottom: 4px;
      display: block;
    }

    input, textarea, select {
      width: 100%;
      font-size: 14px;
      padding: 6px 10px;
      margin-bottom: 12px;
      border: 1px solid #cbd5e1;
      border-radius: 4px;
      box-sizing: border-box;
      background-color: #f8fafc;
    }

    textarea {
      resize: vertical;
    }

    button {
      padding: 8px 14px;
      margin-top: 6px;
      font-size: 14px;
      background-color: #3b82f6;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #2563eb;
    }
    button.danger {
      background-color: #ef4444;
    }
    button.danger:hover {
      background-color: #dc2626;
    }
    button.secondary {
      background-color: #64748b;
    }
    button.secondary:hover {
      background-color: #475569;
    }

    .question-block {
      border: 1px solid #cbd5e1;
      background-color: #f9fafb;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
    }

    #questionList {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    .question-block strong {
      color: #1e40af;
    }

    .question-form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px 12px;
      align-items: center;
    }
    .question-form textarea {
      grid-column: span 2;
    }
    .question-form button {
      grid-column: span 2;
      justify-self: end;
      margin-top: 6px;
    }
    .field-group {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 6px;
      grid-column: span 1;
    }
    .field-group label {
      white-space: nowrap;
      min-width: 80px;
      font-weight: bold;
      text-align: right;
    }
    .field-group input,
    .field-group select {
      flex: 1;
    }
    #pagination {
      margin-top: 20px;
      text-align: center;
    }
    #pagination button {
      margin: 2px;
      background-color: #e2e8f0;
      color: #1e293b;
    }
    #pagination button:disabled {
      background-color: #94a3b8;
      color: white;
    }
    #promoListContainer textarea {
      width: 100%;
      margin-bottom: 8px;
      background-color: #fffefc;
    }
    #promoPreview {
      padding: 12px;
      background-color: #fefce8;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      margin-top: 8px;
    }

    /* å®£å‚³å€å¡Šæ¶ˆé™¤ä¸Šä¸‹ç©ºç™½ */
    .promo-block {
      margin: 0;
      padding: 0;
    }

    #promoListContainer textarea {
      margin: 0;
    }

    #promoPreview {
      margin: 0;
      padding: 0;
    }

</style>
</style>
  <style>
    /* Tooltip Form æ¨£å¼ */
    .tooltip-form {
      margin-top: 8px;
      background: #f8fafc;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      padding: 12px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }
    .tooltip-form label {
      display: block;
      font-weight: bold;
      margin-bottom: 4px;
    }
    .tooltip-form input {
      width: 100%;
      margin-bottom: 10px;
      padding: 6px 8px;
      border: 1px solid #cbd5e1;
      border-radius: 4px;
      background: #ffffff;
    }
  </style>
</head>
<body>
  <div id="loginBox">
    <h2>å¾Œå°ç™»å…¥</h2>
    <input id="email" type="text" placeholder="Email" />
    <input id="password" type="password" placeholder="Password" />
    <button onclick="window.login()">ç™»å…¥</button>
  </div>
  <div id="mainContent" style="display:none">
  <h1>å¤šç›Šåˆ·é¡Œå¾Œå°ç®¡ç†</h1>

  <div class="section">
    <h2>å‰å°è¨­å®šï¼ˆå¯†ç¢¼ï¼‰</h2>
    <label>ç¬¬ä¸€çµ„å¯†ç¢¼ï¼ˆå¥½å‹ï¼‰ï¼š<input type="text" id="pwFriend" placeholder="friend456"></label>
    <label>ç¬¬äºŒçµ„å¯†ç¢¼ï¼ˆå­¸å“¡ï¼‰ï¼š<input type="text" id="pwStudent" placeholder="student123"></label>
    <button onclick="saveSettings()">å„²å­˜å¯†ç¢¼è¨­å®š</button>
    <button onclick="saveAllToFirebase()">ğŸ’¾ å„²å­˜æ‰€æœ‰è®Šæ›´</button>
  </div>

  <div class="section">
    <h2>æ–°å¢é¡Œç›®</h2>
    <label for="qText">é¡Œç›®</label>
    <input id="qText" placeholder="è«‹è¼¸å…¥é¡Œç›®å…§å®¹" />
    <label for="qOptions">é¸é …ï¼ˆè«‹ç”¨é€—è™Ÿåˆ†éš”ï¼‰</label>
    <input id="qOptions" placeholder="ä¾‹å¦‚ï¼šsuccess, successful, successfully, succeed" />
    <label for="qAnswer">æ­£ç¢ºç­”æ¡ˆï¼ˆå¦‚ A/B/C/Dï¼‰</label>
    <input id="qAnswer" placeholder="è«‹è¼¸å…¥æ­£ç¢ºç­”æ¡ˆä»£è™Ÿ" />
    <label for="qExplanation">è§£æ</label>
    <button type="button" class="secondary" onclick="insertTooltipForm(document.getElementById('qExplanation'))">æ’å…¥ Tooltip</button>
    <textarea id="qExplanation" placeholder="è§£é‡‹æ­£ç¢ºç­”æ¡ˆçš„ç†ç”±"></textarea>
    <label for="qHint">æç¤º</label>
    <button type="button" class="secondary" onclick="insertTooltipForm(document.getElementById('qHint'))">æ’å…¥ Tooltip</button>
    <textarea id="qHint" placeholder="æä¾›çµ¦å­¸ç”Ÿçš„è§£é¡Œæç¤º"></textarea>
    <label for="qDeleteWords">åˆªé™¤æ–‡å­—ï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼‰</label>
    <input id="qDeleteWords" placeholder="ä¾‹å¦‚ï¼šhighly, in the new position" />
    <label for="qFreq">é »ç‡</label>
    <select id="qFreq">
      <option value="é«˜é »">é«˜é »</option>
      <option value="æ™®é€š">æ™®é€š</option>
      <option value="ä½é »">ä½é »</option>
    </select>
    <label for="qLevel">é›£åº¦</label>
    <select id="qLevel">
      <option value="é€²éš">é€²éš</option>
      <option value="æ™®é€š">æ™®é€š</option>
      <option value="ç°¡å–®">ç°¡å–®</option>
    </select>
    <label for="qType">é¡å‹</label>
    <select id="qType">
      <option value="çœŸé¡Œ">çœŸé¡Œ</option>
      <option value="é¡Œåº«">é¡Œåº«</option>
    </select>
    <label for="qAuth">æ¬Šé™</label>
    <select id="qAuth">
      <option value="å­¸å“¡">å­¸å“¡</option>
      <option value="å¥½å‹">å¥½å‹</option>
      <option value="è¨ªå®¢">è¨ªå®¢</option>
    </select>
    <label for="qCategory">ä¸»é¡Œåˆ†é¡</label>
    <select id="qCategory">
      <option value="">--è«‹é¸æ“‡æ–‡æ³•ä¸»é¡Œ--</option>
      <option value="å¥å­åŸºæœ¬æ¶æ§‹">å¥å­åŸºæœ¬æ¶æ§‹</option>
      <option value="ä¸»è©å‹•è©ä¸€è‡´æ€§">ä¸»è©å‹•è©ä¸€è‡´æ€§</option>
      <option value="ä»£åè©èˆ‡æ ¼ä½ç”¨æ³•">ä»£åè©èˆ‡æ ¼ä½ç”¨æ³•</option>
      <option value="åè©èˆ‡å½¢å®¹è©æ­é…">åè©èˆ‡å½¢å®¹è©æ­é…</option>
      <option value="æ¯”è¼ƒç´šèˆ‡æœ€é«˜ç´š">æ¯”è¼ƒç´šèˆ‡æœ€é«˜ç´š</option>
      <option value="ä»‹ç³»è©çš„ç”¨æ³•">ä»‹ç³»è©çš„ç”¨æ³•</option>
      <option value="å‹•è©ç¨®é¡èˆ‡æ­é…">å‹•è©ç¨®é¡èˆ‡æ­é…</option>
      <option value="å‹•è©æ™‚æ…‹">å‹•è©æ™‚æ…‹</option>
      <option value="å‹•åè©èˆ‡ä¸å®šè©">å‹•åè©èˆ‡ä¸å®šè©</option>
      <option value="å­å¥èˆ‡åˆ†è©æ§‹å¥">å­å¥èˆ‡åˆ†è©æ§‹å¥</option>
      <option value="å‰¯è©èˆ‡é€£æ¥è©æ¯”è¼ƒ">å‰¯è©èˆ‡é€£æ¥è©æ¯”è¼ƒ</option>
      <option value="å‹•è©ç‰‡èª">å‹•è©ç‰‡èª</option>
      <option value="å‡è¨­èªæ°£èˆ‡æ¢ä»¶å¥">å‡è¨­èªæ°£èˆ‡æ¢ä»¶å¥</option>
      <option value="å€’è£èˆ‡çœç•¥">å€’è£èˆ‡çœç•¥</option>
      <option value="å½¢å®¹è©å­å¥é€²éšç”¨æ³•">å½¢å®¹è©å­å¥é€²éšç”¨æ³•</option>
      <option value="ç‰¹æ®Šæ–‡æ³•çµæ§‹">ç‰¹æ®Šæ–‡æ³•çµæ§‹</option>
    </select>
    <button id="addBtn">æ–°å¢é¡Œç›®</button>
  </div>

  <div class="section">
    <h2>é¡Œåº«ç®¡ç†</h2>
    <button onclick="downloadQuestions()">ğŸ“¤ åŒ¯å‡ºé¡Œåº«</button>
    <input type="file" id="fileInput" accept=".json" />
    <button onclick="uploadQuestions()">ğŸ“¥ åŒ¯å…¥é¡Œåº«</button>
    <select id="filterCategory" onchange="renderQuestions()">
      <option value="">ğŸ” ç¯©é¸ä¸»é¡Œï¼ˆå…¨éƒ¨ï¼‰</option>
      <option value="å¥å­åŸºæœ¬æ¶æ§‹">å¥å­åŸºæœ¬æ¶æ§‹</option>
      <option value="ä¸»è©å‹•è©ä¸€è‡´æ€§">ä¸»è©å‹•è©ä¸€è‡´æ€§</option>
      <option value="ä»£åè©èˆ‡æ ¼ä½ç”¨æ³•">ä»£åè©èˆ‡æ ¼ä½ç”¨æ³•</option>
      <option value="åè©èˆ‡å½¢å®¹è©æ­é…">åè©èˆ‡å½¢å®¹è©æ­é…</option>
      <option value="æ¯”è¼ƒç´šèˆ‡æœ€é«˜ç´š">æ¯”è¼ƒç´šèˆ‡æœ€é«˜ç´š</option>
      <option value="ä»‹ç³»è©çš„ç”¨æ³•">ä»‹ç³»è©çš„ç”¨æ³•</option>
      <option value="å‹•è©ç¨®é¡èˆ‡æ­é…">å‹•è©ç¨®é¡èˆ‡æ­é…</option>
      <option value="å‹•è©æ™‚æ…‹">å‹•è©æ™‚æ…‹</option>
      <option value="å‹•åè©èˆ‡ä¸å®šè©">å‹•åè©èˆ‡ä¸å®šè©</option>
      <option value="å­å¥èˆ‡åˆ†è©æ§‹å¥">å­å¥èˆ‡åˆ†è©æ§‹å¥</option>
      <option value="å‰¯è©èˆ‡é€£æ¥è©æ¯”è¼ƒ">å‰¯è©èˆ‡é€£æ¥è©æ¯”è¼ƒ</option>
      <option value="å‹•è©ç‰‡èª">å‹•è©ç‰‡èª</option>
      <option value="å‡è¨­èªæ°£èˆ‡æ¢ä»¶å¥">å‡è¨­èªæ°£èˆ‡æ¢ä»¶å¥</option>
      <option value="å€’è£èˆ‡çœç•¥">å€’è£èˆ‡çœç•¥</option>
      <option value="å½¢å®¹è©å­å¥é€²éšç”¨æ³•">å½¢å®¹è©å­å¥é€²éšç”¨æ³•</option>
      <option value="ç‰¹æ®Šæ–‡æ³•çµæ§‹">ç‰¹æ®Šæ–‡æ³•çµæ§‹</option>
    </select>
  </div>

  <div class="section">
    <h2>ç¾æœ‰é¡Œç›®</h2>
    <div style="text-align:right; margin-bottom:8px;">
      <button onclick="toggleAllQuestions(true)">å…¨éƒ¨å±•é–‹</button>
      <button onclick="toggleAllQuestions(false)">å…¨éƒ¨æ”¶åˆ</button>
      <button onclick="clearAllQuestions()" style="background-color: darkred; color: white; margin-left: 10px;">ğŸ§¹ æ¸…ç©ºå…¨éƒ¨é¡Œç›®</button>
    </div>
    <div id="questionList"></div>
    <div id="pagination" style="margin-top: 20px; text-align: center;"></div>
  </div>

<br>

<div class="section">
  <h2>å®£å‚³å…§å®¹ç®¡ç†ï¼ˆå¤šçµ„ / æ”¯æ´ HTMLï¼‰</h2>
  <div id="promoListContainer"></div>
  <button onclick="addPromoItem()">â• æ–°å¢ä¸€æ®µå®£å‚³</button>
  <button onclick="savePromoList()" style="margin-left:10px;">ğŸ’¾ å„²å­˜æ‰€æœ‰å®£å‚³</button>
  <button onclick="clearPromoList()" style="margin-left:10px; background-color: darkred;">ğŸ§¹ æ¸…ç©ºå…¨éƒ¨å®£å‚³</button>
  <div id="promoSaveStatus" style="margin-top:10px; color:green; font-weight:bold;"></div>

  <h3>ğŸ” é è¦½å€</h3>
  <div id="promoPreview"></div>
</div>

  </div>

  <script>
    let questions = [];
    let currentPage = 1;
    const questionsPerPage = 20;

    function saveQuestions() {
      localStorage.setItem('toeicQuestions', JSON.stringify(questions));
    }

    function loadQuestions() {
      const saved = localStorage.getItem('toeicQuestions');
      if (saved) {
        try { questions = JSON.parse(saved); } catch (e) { questions = []; }
      }
    }

    function renderQuestions() {
      const list = document.getElementById('questionList');
      const filter = document.getElementById('filterCategory')?.value;
      const pagination = document.getElementById('pagination');
      list.innerHTML = '';
      pagination.innerHTML = '';

      // ç¯©é¸å¾Œçš„é¡Œç›®
      const filtered = questions.filter(q => !filter || q.category === filter);
      const totalPages = Math.ceil(filtered.length / questionsPerPage);
      // è‹¥ç›®å‰é è¶…éæœ€å¤§é ï¼Œé‡è¨­
      if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;
      if (currentPage < 1) currentPage = 1;
      const startIdx = (currentPage - 1) * questionsPerPage;
      const endIdx = startIdx + questionsPerPage;
      const pageItems = filtered.slice(startIdx, endIdx);

      pageItems.forEach((q, idx) => {
        const globalIndex = startIdx + idx;
        const block = document.createElement('div');
        block.className = 'question-block';

        // é¡Œè™Ÿã€æ”¶åˆã€åˆªé™¤æŒ‰éˆ•åˆä½µæ©«æ’
        const header = document.createElement('div');
        header.style.display = 'flex';
        header.style.justifyContent = 'space-between';
        header.style.alignItems = 'center';

        const title = document.createElement('strong');
        title.textContent = `Q${globalIndex + 1}`;

        const rightBtns = document.createElement('div');
        rightBtns.style.display = 'flex';
        rightBtns.style.gap = '6px';

        const toggleBtn = document.createElement('button');
        toggleBtn.textContent = 'ğŸ”½ æ”¶åˆ';
        toggleBtn.onclick = () => {
          const form = block.querySelector('.question-form');
          const isHidden = form.style.display === 'none';
          form.style.display = isHidden ? '' : 'none';
          toggleBtn.textContent = isHidden ? 'ğŸ”½ æ”¶åˆ' : 'ğŸ”¼ å±•é–‹';
        };

        const delBtn = document.createElement('button');
        delBtn.textContent = 'ğŸ—‘ï¸';
        delBtn.className = 'danger';
        delBtn.title = 'åˆªé™¤æœ¬é¡Œ';
        delBtn.onclick = () => deleteQuestion(globalIndex);

        rightBtns.appendChild(toggleBtn);
        rightBtns.appendChild(delBtn);

        header.appendChild(title);
        header.appendChild(rightBtns);
        block.appendChild(header);

        // é¡Œç›®å…§å®¹å€ï¼ˆå¯æ”¶åˆï¼‰
        const formDiv = document.createElement('div');
        formDiv.className = 'question-form';

        // è§£æ textarea + æ’å…¥ Tooltip æŒ‰éˆ•
        const explanationId = `explanation-${globalIndex}`;
        const hintId = `hint-${globalIndex}`;

        formDiv.innerHTML = `
          <div class="field-group" style="grid-column: span 2;">
            <label>é¡Œç›®ï¼š</label>
            <input value="${q.text}" onchange="questions[${globalIndex}].text = this.value; saveQuestions()" />
          </div>
          <div class="field-group">
            <label>æ­£ç¢ºç­”æ¡ˆï¼š</label>
            <input value="${q.answer}" onchange="questions[${globalIndex}].answer = this.value; saveQuestions()" />
          </div>
          <div class="field-group">
            <label>é¸é …ï¼š</label>
            <input value="${q.options.join(', ')}" onchange="questions[${globalIndex}].options = this.value.split(',').map(x => x.trim()); saveQuestions()" />
          </div>
          <div class="field-group" style="grid-column: span 2;">
            <label>è§£æï¼š</label>
            <textarea id="${explanationId}" rows="3" style="flex:1" onchange="questions[${globalIndex}].explanation = this.value; saveQuestions()">${q.explanation}</textarea>
            <button type="button" class="secondary" onclick="insertTooltipForm(this.previousElementSibling)">æ’å…¥ Tooltip</button>
          </div>
          <div class="field-group" style="grid-column: span 2;">
            <label>æç¤ºï¼š</label>
            <textarea id="${hintId}" rows="2" style="flex:1" onchange="questions[${globalIndex}].hint = this.value; saveQuestions()">${q.hint}</textarea>
            <button type="button" class="secondary" onclick="insertTooltipForm(this.previousElementSibling)">æ’å…¥ Tooltip</button>
          </div>
          <div class="field-group" style="grid-column: span 2;">
            <label>åˆªé™¤æ–‡å­—ï¼š</label>
            <input style="flex:1" value="${q.deleteWords?.join(', ') ?? ''}" onchange="questions[${globalIndex}].deleteWords = this.value.split(',').map(x => x.trim()); saveQuestions()">
          </div>
          <div class="field-group">
            <label>é »ç‡ï¼š</label>
            <select onchange="questions[${globalIndex}].freq = this.value; saveQuestions()">
              <option ${q.freq==='é«˜é »'?'selected':''}>é«˜é »</option>
              <option ${q.freq==='æ™®é€š'?'selected':''}>æ™®é€š</option>
              <option ${q.freq==='ä½é »'?'selected':''}>ä½é »</option>
            </select>
          </div>
          <div class="field-group">
            <label>é›£åº¦ï¼š</label>
            <select onchange="questions[${globalIndex}].level = this.value; saveQuestions()">
              <option ${q.level==='é€²éš'?'selected':''}>é€²éš</option>
              <option ${q.level==='æ™®é€š'?'selected':''}>æ™®é€š</option>
              <option ${q.level==='ç°¡å–®'?'selected':''}>ç°¡å–®</option>
            </select>
          </div>
          <div class="field-group">
            <label>é¡å‹ï¼š</label>
            <select onchange="questions[${globalIndex}].type = this.value; saveQuestions()">
              <option ${q.type==='çœŸé¡Œ'?'selected':''}>çœŸé¡Œ</option>
              <option ${q.type==='é¡Œåº«'?'selected':''}>é¡Œåº«</option>
            </select>
          </div>
          <div class="field-group">
            <label>æ¬Šé™ï¼š</label>
            <select onchange="questions[${globalIndex}].auth = this.value; saveQuestions()">
              <option ${q.auth==='å­¸å“¡'?'selected':''}>å­¸å“¡</option>
              <option ${q.auth==='å¥½å‹'?'selected':''}>å¥½å‹</option>
              <option ${q.auth==='è¨ªå®¢'?'selected':''}>è¨ªå®¢</option>
            </select>
          </div>
          <div class="field-group" style="grid-column: span 2;">
            <label>ä¸»é¡Œåˆ†é¡ï¼š</label>
            <select style="flex:1" onchange="questions[${globalIndex}].category = this.value; saveQuestions()">
              ${[
                "å¥å­åŸºæœ¬æ¶æ§‹","ä¸»è©å‹•è©ä¸€è‡´æ€§","ä»£åè©èˆ‡æ ¼ä½ç”¨æ³•","åè©èˆ‡å½¢å®¹è©æ­é…",
                "æ¯”è¼ƒç´šèˆ‡æœ€é«˜ç´š","ä»‹ç³»è©çš„ç”¨æ³•","å‹•è©ç¨®é¡èˆ‡æ­é…","å‹•è©æ™‚æ…‹",
                "å‹•åè©èˆ‡ä¸å®šè©","å­å¥èˆ‡åˆ†è©æ§‹å¥","å‰¯è©èˆ‡é€£æ¥è©æ¯”è¼ƒ","å‹•è©ç‰‡èª",
                "å‡è¨­èªæ°£èˆ‡æ¢ä»¶å¥","å€’è£èˆ‡çœç•¥","å½¢å®¹è©å­å¥é€²éšç”¨æ³•","ç‰¹æ®Šæ–‡æ³•çµæ§‹"
              ].map(cat => `<option ${q.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}
            </select>
          </div>
        `;

        block.appendChild(formDiv);
        list.appendChild(block);
      });

      // å»ºç«‹åˆ†é æŒ‰éˆ•
      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.style.margin = '0 4px';
        btn.disabled = i === currentPage;
        btn.onclick = () => {
          currentPage = i;
          renderQuestions();
        };
        pagination.appendChild(btn);
      }
    }

    function addQuestion() {
      const qText = document.getElementById('qText').value.trim();
      const qOptions = document.getElementById('qOptions').value.split(',').map(x => x.trim());
      const qAnswer = document.getElementById('qAnswer').value.trim();
      if (!qText || qOptions.length < 2 || !qAnswer) {
        alert("è«‹å¡«å¯«é¡Œç›®ã€è‡³å°‘å…©å€‹é¸é …èˆ‡æ­£ç¢ºç­”æ¡ˆ"); return;
      }
      const q = {
        text: qText,
        options: qOptions,
        answer: qAnswer,
        explanation: document.getElementById('qExplanation').value.trim(),
        hint: document.getElementById('qHint').value.trim(),
        deleteWords: document.getElementById('qDeleteWords').value.split(',').map(x => x.trim()),
        freq: document.getElementById('qFreq').value,
        level: document.getElementById('qLevel').value,
        type: document.getElementById('qType').value,
        auth: document.getElementById('qAuth').value,
        category: document.getElementById('qCategory').value
      };
      questions.push(q);
      saveQuestions(); renderQuestions();
      document.querySelectorAll('#qText, #qOptions, #qAnswer, #qExplanation, #qHint, #qDeleteWords').forEach(e => e.value = '');
      ['qFreq','qLevel','qType','qAuth','qCategory'].forEach(id => document.getElementById(id).selectedIndex = 0);
    }

    function deleteQuestion(index) {
      if (confirm("ç¢ºå®šè¦åˆªé™¤é€™é¡Œå—ï¼Ÿ")) {
        questions.splice(index, 1);
        saveQuestions(); renderQuestions();
      }
    }

    function saveSettings() {
      const settings = {
        passwordStudent: document.getElementById('pwStudent').value.trim(),
        passwordFriend: document.getElementById('pwFriend').value.trim()
      };
      localStorage.setItem('toeicSettings', JSON.stringify(settings));
      alert("å¯†ç¢¼è¨­å®šå·²å„²å­˜ï¼");
    }

    function loadSettings() {
      const saved = localStorage.getItem('toeicSettings');
      if (saved) {
        try {
          const settings = JSON.parse(saved);
          document.getElementById('pwStudent').value = settings.passwordStudent || '';
          document.getElementById('pwFriend').value = settings.passwordFriend || '';
        } catch {}
      }
    }

    function downloadQuestions() {
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(questions, null, 2));
      const dlAnchorElem = document.createElement('a');
      dlAnchorElem.setAttribute("href", dataStr);
      dlAnchorElem.setAttribute("download", "toeic_questions.json");
      dlAnchorElem.click();
    }

    function uploadQuestions() {
      const fileInput = document.getElementById('fileInput');
      if (!fileInput.files.length) { alert("è«‹é¸æ“‡ JSON æª”æ¡ˆ"); return; }
      const file = fileInput.files[0];
      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const imported = JSON.parse(e.target.result);
          if (Array.isArray(imported)) {
            questions = questions.concat(imported);
            saveQuestions(); renderQuestions();
            alert("é¡Œåº«åŒ¯å…¥æˆåŠŸï¼");
          } else {
            alert("æ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºèªç‚ºé¡Œåº« JSON æª”");
          }
        } catch (err) {
          alert("è®€å–éŒ¯èª¤ï¼š" + err.message);
        }
      };
      reader.readAsText(file);
    }

    document.getElementById('addBtn').addEventListener('click', addQuestion);
    // Firebase è¼‰å…¥å¾Œæœƒè‡ªå‹• renderQuestions()

    // å…¨éƒ¨å±•é–‹/æ”¶åˆåŠŸèƒ½
    function toggleAllQuestions(expand) {
      document.querySelectorAll('.question-form').forEach(form => {
        form.style.display = expand ? '' : 'none';
      });
      document.querySelectorAll('.question-block button').forEach(btn => {
        if (btn.textContent.includes('æ”¶åˆ') || btn.textContent.includes('å±•é–‹')) {
          btn.textContent = expand ? 'ğŸ”½ æ”¶åˆ' : 'ğŸ”¼ å±•é–‹';
        }
      });
    }

    // æ¸…ç©ºå…¨éƒ¨é¡Œç›®
    function clearAllQuestions() {
      if (confirm("âš ï¸ ç¢ºå®šè¦åˆªé™¤å…¨éƒ¨é¡Œç›®å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•é‚„åŸï¼")) {
        questions = [];
        localStorage.removeItem('toeicQuestions');
        saveQuestions();
        renderQuestions();
        alert("âœ… é¡Œåº«å·²æ¸…ç©ºï¼");
      }
    }


    function renderPromoEditor() {
      let list = [];
      try {
        list = JSON.parse(localStorage.getItem('toeicPromoList'));
        if (!Array.isArray(list)) throw 'invalid format';
      } catch {
        list = [];
      }

      const container = document.getElementById('promoListContainer');
      container.innerHTML = '';

      list.forEach((html, idx) => {
        const block = document.createElement('div');
        block.className = 'promo-block';

        const label = document.createElement('div');
        label.textContent = `ç¬¬ ${idx + 1} æ®µå®£å‚³å…§å®¹ï¼š`;
        label.style.fontWeight = 'bold';

        const textarea = document.createElement('textarea');
        textarea.value = html;
        textarea.rows = 5;
        textarea.dataset.index = idx;
        textarea.oninput = () => previewPromo(textarea.value);

        const delBtn = document.createElement('button');
        delBtn.textContent = 'ğŸ—‘ï¸ åˆªé™¤';
        delBtn.onclick = () => {
          list.splice(idx, 1);
          localStorage.setItem('toeicPromoList', JSON.stringify(list));
          renderPromoEditor();
        };

        block.appendChild(label);
        block.appendChild(textarea);
        block.appendChild(delBtn);
        container.appendChild(block);
      });
    }

    function addPromoItem() {
      const list = getCurrentList();
      list.push('<p>è«‹åœ¨æ­¤è¼¸å…¥ HTML å®£å‚³å…§å®¹</p>');
      localStorage.setItem('toeicPromoList', JSON.stringify(list));
      renderPromoEditor();
    }

    function savePromoList() {
      const updated = Array.from(document.querySelectorAll('#promoListContainer textarea')).map(t => t.value);
      try {
        localStorage.setItem('toeicPromoList', JSON.stringify(updated));
        document.getElementById('promoSaveStatus').textContent = 'âœ… å®£å‚³å…§å®¹å·²å„²å­˜';
      } catch (e) {
        document.getElementById('promoSaveStatus').textContent = 'âŒ å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥å…§å®¹æ ¼å¼';
      }
      setTimeout(() => document.getElementById('promoSaveStatus').textContent = '', 3000);
      renderPromoEditor();
    }

    function clearPromoList() {
  localStorage.removeItem('toeicPromoList');
  document.getElementById('promoSaveStatus').textContent = 'ğŸ§¹ å·²æ¸…ç©ºå…¨éƒ¨å®£å‚³';
  setTimeout(() => document.getElementById('promoSaveStatus').textContent = '', 3000);
  renderPromoEditor();
}

    function previewPromo(html) {
      document.getElementById('promoPreview').innerHTML = html;
    }

    function getCurrentList() {
      try {
        const data = JSON.parse(localStorage.getItem('toeicPromoList'));
        return Array.isArray(data) ? data : [];
      } catch {
        return [];
      }
    }

    // åƒ…é¦–æ¬¡åˆå§‹åŒ–æ™‚æä¾›é è¨­è³‡æ–™
    try {
      const current = JSON.parse(localStorage.getItem('toeicPromoList'));
      if (!Array.isArray(current)) throw 'invalid';
    } catch {
      localStorage.setItem('toeicPromoList', JSON.stringify([
        "<p>ğŸ“ <strong>åŠ å…¥æ–‡æ³•ç²¾ä¿®ç­</strong>ï¼Œç³»çµ±åŒ–æå‡ä½ çš„è‹±æ–‡å¯«ä½œèƒ½åŠ›ï¼<br><a href='https://yourcourse.com/grammar' target='_blank'>ğŸ‘‰ é»æˆ‘äº†è§£è©³æƒ…</a></p>",
        "<p>ğŸ“š <strong>å…è²»ç›´æ’­è©¦è½èª²</strong> æ¯é€±äº”æ™šä¸Š 8 é»æº–æ™‚é–‹è¬›ï¼<br><a href='https://yourcourse.com/live' target='_blank'>ç«‹å³å ±å</a></p>",
        "<p>ğŸ”¥ <strong>é™æ™‚ 8 æŠ˜å„ªæƒ </strong> åªåˆ°æœ¬é€±æ—¥ï¼åˆ¥éŒ¯éé€™æ¬¡æ©Ÿæœƒï½<br><a href='https://yourcourse.com/promo' target='_blank'>æ¶å…ˆçœ‹å„ªæƒ å…§å®¹</a></p>"
      ]));
    }

    renderPromoEditor();

    // ä¸€éµåŒæ­¥æ‰€æœ‰è³‡æ–™åˆ° Firebaseï¼ˆåŠ ä¸Š Firebase Tokenï¼‰
    async function saveAllToFirebase() {
      const promoList = getCurrentList();
      const settings = {
        passwordStudent: document.getElementById('pwStudent').value.trim(),
        passwordFriend: document.getElementById('pwFriend').value.trim()
      };
      const dataToSave = { settings, questions, promoList };
      try {
        const token = window.getFirebaseToken?.();
        if (!token) {
          alert("æœªç™»å…¥æˆ– Token å¤±æ•ˆ"); return;
        }
        const response = await fetch("https://toeic-990-johnny-default-rtdb.asia-southeast1.firebasedatabase.app/toeicData.json?auth=" + token, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(dataToSave)
        });
        if (response.ok) {
          alert("âœ… æ‰€æœ‰è³‡æ–™å·²æˆåŠŸå„²å­˜åˆ° Firebaseï¼");
        } else {
          alert("âŒ å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Firebase æ¬Šé™è¨­å®š");
        }
      } catch (err) {
        alert("âŒ ç„¡æ³•å–å¾—æˆæ¬Š Tokenï¼Œè«‹é‡æ–°ç™»å…¥æˆ–æª¢æŸ¥ç™»å…¥ç‹€æ…‹");
        console.error(err);
      }
    }

    // æ’å…¥ Tooltip è¡¨å–®
    function insertTooltipForm(textarea) {
      if (textarea.nextElementSibling?.classList?.contains('tooltip-form')) return;

      const form = document.createElement('div');
      form.className = 'tooltip-form';
      form.innerHTML = `
        <label>æç¤ºå…§å®¹ <input type="text" class="tooltip-tip"></label>
        <label>é¡¯ç¤ºæ–‡å­— <input type="text" class="tooltip-show"></label>
        <label>è¶…é€£çµç¶²å€ï¼ˆå¯ç•™ç©ºï¼‰<input type="text" class="tooltip-link"></label>
        <div style="text-align:right; margin-top:6px;">
          <button type="button" class="secondary" onclick="confirmTooltipInsert(this)">æ’å…¥</button>
          <button type="button" onclick="this.closest('.tooltip-form').remove()">å–æ¶ˆ</button>
        </div>
      `;
      textarea.insertAdjacentElement('afterend', form);
    }

    function confirmTooltipInsert(btn) {
      const form = btn.closest('.tooltip-form');
      const textarea = form.previousElementSibling;
      const tip = form.querySelector('.tooltip-tip').value.trim().replace(/"/g, '&quot;');
      const show = form.querySelector('.tooltip-show').value.trim();
      const link = form.querySelector('.tooltip-link').value.trim();
      const html = link
        ? `<a href="${link}" target="_blank"><span class="tipbox" data-tip="${tip}">${show}</span></a>`
        : `<span class="tipbox" data-tip="${tip}">${show}</span>`;
      textarea.value += (textarea.value ? '\n' : '') + html;
      textarea.focus();
      form.remove();
    }
  </script>


<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCp9Dht56nKx5oq4WELaInsTrgG-KeRJcA",
    authDomain: "toeic-990-johnny.firebaseapp.com",
    databaseURL: "https://toeic-990-johnny-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "toeic-990-johnny",
    storageBucket: "toeic-990-johnny.firebasestorage.app",
    messagingSenderId: "433719887286",
    appId: "1:433719887286:web:43418d0c883462f1746d17"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth();

  async function login() {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    try {
      const userCredential = await signInWithEmailAndPassword(auth, email, password);
      const user = userCredential.user;
      if (user.email !== "johnnyice0109@gmail.com") {
        alert("æœªæˆæ¬Šå¸³è™Ÿ"); auth.signOut(); return;
      }

      document.getElementById('loginBox').style.display = 'none';
      document.getElementById('mainContent').style.display = '';

      const token = await user.getIdToken();
      const dbUrl = "https://toeic-990-johnny-default-rtdb.asia-southeast1.firebasedatabase.app/toeicData.json?auth=" + token;
      const res = await fetch(dbUrl);
      const data = await res.json();
      if (!data) return;
      questions = data.questions || [];
      const promoRaw = data.promoList || [];
      localStorage.setItem('toeicPromoList', JSON.stringify(promoRaw));
      renderPromoEditor();
      const settings = data.settings || {};
      document.getElementById('pwStudent').value = settings.passwordStudent || '';
      document.getElementById('pwFriend').value = settings.passwordFriend || '';
      renderQuestions();

      window.getFirebaseToken = () => token;
    } catch (e) {
      alert("ç™»å…¥å¤±æ•—ï¼š" + e.message);
    }
  }

  window.login = login;
</script>

</body>
</html>